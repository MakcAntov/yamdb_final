# Финальный проект Yamdb_final

![workflow](https://github.com/MakcAntov/yamdb_final/actions/workflows/yamdb_workflow.yml/badge.svg)

## Описание

**YaMDb API** - это учебный проект от Яндекс.Практикум, который собирает отзывы ***(Review)*** пользователей на произведения ***(Titles)***. 
* Произведения делятся на категории ***(Category)***: «Книги», «Фильмы», «Музыка». Список может быть расширен администратором;
* В каждой категории есть **произведения**: книги, фильмы или музыка;
* Произведению может быть присвоен жанр ***(Genre)*** из списка предустановленных (например, «Сказка», «Рок» или «Артхаус»). Новые жанры может создавать только администратор;
* Пользователи оставляют к произведениям текстовые отзывы **(Review)** и комментарии **(Comment)**, а так же ставят произведению оценку в диапазоне от одного до десяти (целое число);
* Из пользовательских оценок формируется усреднённая оценка произведения — **рейтинг** (целое число).

## Использованные технологии

- Python
- Django REST
- Nginx
- Postgres
- Docker

## Задача проекта

На данном этапе проекта, предполагается написать *Workflow* для приложений **Continuous Integration** и **Continuous Deployment**.

**Workflow** — это инструкция с набором команд, которые выполнятся в виртуальном окружении после того, как произойдёт какое-то событие-триггер.

Инструкция запустит:
* автоматические тесты;
* обновление образов на Docker Hub;
* автоматический деплой на боевой сервер при `push` в главную ветку *main*.
* отправка уведомления в Telegram о том, что процесс деплоя успешно завершился.

## Переменные окружения. Шаблон .ENV

При разработки web-приложения или бота мы часто имеем дело с какой-либо секретной информацией, различными токенами и паролями. Показывать в публично доступной системе контроля версий - плохая идея.
Переменные окружения это именованные переменные, содержащие текстовую информацию, которую могут использовать запускаемые программы. 
Чтобы не задавать каждый раз вручную переменные окружения при новом запуске терминала, можно воспользоваться пакетом *python-dotenv*. Он позволяет загружать переменные окружения из файла `.env` в корневом каталоге приложения.
В `requirements.txt` уже добавлен пакет `python-dotenv`, остаётся только настроить в `settings.py` нужные параметры. 
Шаблон `.env` файла:
```
SECRET_KEY=<very_long_key>
DB_ENGINE=django.db.backends.postgresql # указываем, что работаем с postgresql
DB_NAME=postgres # имя базы данных
POSTGRES_USER=postgres # логин для подключения к базе данных
POSTGRES_PASSWORD=postgres12345 # пароль для подключения к БД (установите свой)
DB_HOST=db # название сервиса (контейнера)
DB_PORT=5432 # порт для подключения к БД
```

## Как запустить проект на локальной машине:
* Клонировать проект с GitHub:
`git clone git@github.com:MakcAntov/yamdb_final.git`
* Пройти в директорию с Docker-compose:
`cd yamdb_final/infra`
* Создать *.env* файл и наполнить по шаблону выше:
`touch .env` и `nano .env`
* Запустить утилиту Docker-compose:
`docker-compose up -d`
* Применить миграции:
`docker-compose exec web python manage.py migrate`
* Собрать статику:
`docker-compose exec web python manage.py collectstatic --no-input`
* Перезапустить контейнеры:
`docker-compose restart`
* *Если нужно загрузить дамп из БД, то смотри инструкцию ниже по "Работе с БД"*
* Создать администратора:
`docker-compose exec web python manage.py createsuperuser`

## Работа с БД.
Потеря данных из базы — одно из самых печальных и непоправимых событий, которые могут приключиться. Программные файлы, код, систему — всё это можно восстановить, но как вернуть, например, базу клиентов, накопленную за несколько лет?

Вот волшебные строки cmd:
* Cоздать дамп (резервную копию) базы:
```
docker-compose exec web python manage.py dumpdata > fixtures.json
```
* Загрузка на сервер из дампа:
```
docker cp fixtures.json infra-web-1:/app
docker-compose exec web python manage.py loaddata fixtures.json
```

## Завершение работы
Чтобы собранные контейнеры не мешали вам, остановите их командой:
```
docker-compose down -v
```


## Алгоритм регистрации пользователей:

* Пользователь отправляет POST-запрос на добавление нового пользователя с параметрами `email` и `username` на эндпоинт `/api/v1/auth/signup/`.
* **YaMDB** отправляет письмо с кодом подтверждения (`confirmation_code`) на адрес  `email`.
* Пользователь отправляет POST-запрос с параметрами `username` и `confirmation_code` на эндпоинт `/api/v1/auth/token/`, в ответе на запрос ему приходит `token` (JWT-токен).
* При желании пользователь отправляет PATCH-запрос на эндпоинт `/api/v1/users/me/` и заполняет поля в своём профайле.

## Для взаимодействия с ресурсами Api_Yambd настроены следующие эндпоинты:

* `api/v1/auth/signup/` Регистрация нового пользователя.
* `api/v1/auth/token/` Получение JWT-токена.
* `api/v1/categories/` Получение списка всех категорий. Добавление категории.
* `api/v1/categories/{slug}/` Удаление категории.
* `api/v1/genres/` Получение списка всех жанров. Добавление жанра.
* `api/v1/genres/{slug}/` Удаление жанра.
* `api/v1/titles/` Получение списка всех произведений. Добавление произведения.
* `api/v1/titles/{titles_id}/` Получение информации о произведении, а так же частичное обновление и удаление.
* `api/v1/titles/{title_id}/reviews/` Получение списка всех отзывов. Добавление отзыва.
* `api/v1/titles/{title_id}/reviews/{review_id}/` Получить, частично обновить и удалить отзыв по `id` для указанного произведения.
* `api/v1/titles/{title_id}/reviews/{review_id}/comments/` Получение списка всех комментариев к отзыву. Добавление комментария.
* `api/v1/titles/{title_id}/reviews/{review_id}/comments/{comment_id}/` Получить, частично обновить, удалить комментарий для отзыва по `id`.
* `api/v1/users/` Получение списка всех пользователей. Добавление пользователя.
* `api/v1/users/{username}/` Получение, изменение и удаление пользователя по username.
* `api/v1/users/me/` Изменение данных своей учетной записи.

Подробнее можно ознакомиться в документации:
`http://localhost/redoc`

## Некоторые примеры запросов к API:

Пример POST-запроса с токеном авторизованного пользователя `Oleg`: 
добавление нового отзыва к произведению `id=4`

`POST .../api/v1/titles/4/reviews/`

```json
{
  "text": "Кроссовер вышел, ИМХО, ну такое.",
  "score": 5
}
```
Ответ:
```json
{
    "id": 3,
    "text": "Кроссовер вышел, ИМХО, ну такое.",
    "author": "Oleg",
    "score": 5,
    "pub_date": "2022-10-09T18:04:02.973364Z"
}
```
Пример GET-запроса без токена: получаем список отзывов к произведению с `id=3`.

`GET .../api/v1/titles/3/reviews/`

Ответ:
```json
{
    "count": 1,
    "next": null,
    "previous": null,
    "results": [
        {
            "id": 1,
            "text": "Молодец гимнастка!",
            "author": "admin",
            "score": 5,
            "pub_date": "2022-10-03T11:46:39.066000Z"
        }
    ]
}
```

Пример GET-запросов без токена: получаем информацию о категориях.

`GET ...api/v1/categories/ `

Ответ:
```json
{
    "count": 2,
    "next": null,
    "previous": null,
    "results": [
        {
            "name": "Sport",
            "slug": "sport"
        },
        {
            "name": "Car",
            "slug": "car"
        }
    ]
}
```
## Где посмотреть?

Когда ВМ запущена, то можно открыть по адресу:
[http://kvazar.ddns.net/](http://kvazar.ddns.net/)

Документация:
[http://kvazar.ddns.net/redoc](http://kvazar.ddns.net/redoc)

### Контактные данные:
:octocat: [GitHub](https://github.com/MakcAntov)

 :arrow_backward: [Telegram](https://t.me/AntMakc)